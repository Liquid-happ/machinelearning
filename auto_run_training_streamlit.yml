name: Auto Run Training and Streamlit

on:
  schedule:
    - cron: '0 */6 * * *'  # Ch·∫°y m·ªói 6 gi·ªù ƒë√∫ng ph√∫t 00 (UTC)
  workflow_dispatch:       # Cho ph√©p ch·∫°y th·ªß c√¥ng n·∫øu c·∫ßn

jobs:
  run-training-streamlit:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # Cho ph√©p commit & push thay ƒë·ªïi

    steps:
      # B∆∞·ªõc 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # B∆∞·ªõc 2: Thi·∫øt l·∫≠p Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      # B∆∞·ªõc 3: C√†i ƒë·∫∑t dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Kh√¥ng c·∫ßn playwright n·∫øu kh√¥ng s·ª≠ d·ª•ng, b·ªè n·∫øu kh√¥ng c·∫ßn

      # B∆∞·ªõc 4: Ch·∫°y script hu·∫•n luy·ªán (huanluyen6.py)
      - name: Run training script
        run: |
          python huanluyen6.py
        timeout-minutes: 15  # TƒÉng th·ªùi gian timeout n·∫øu hu·∫•n luy·ªán l√¢u

      # B∆∞·ªõc 5: Ch·∫°y script Streamlit (streamlit6.py)
      - name: Run Streamlit script
        run: |
          streamlit run streamlit6.py --server.port 8501 &
          sleep 10  # ƒê·ª£i ·ª©ng d·ª•ng kh·ªüi ƒë·ªông (c√≥ th·ªÉ ƒëi·ªÅu ch·ªânh th·ªùi gian)
        timeout-minutes: 5

      # B∆∞·ªõc 6: Ki·ªÉm tra v√† commit n·∫øu c√≥ thay ƒë·ªïi (m√¥ h√¨nh ho·∫∑c d·ªØ li·ªáu)
      - name: Commit and push changes
        run: |
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

          if git status --porcelain | grep -E "models/|all_cities_aqi_data.csv"; then
            echo "üì¶ File m√¥ h√¨nh ho·∫∑c d·ªØ li·ªáu thay ƒë·ªïi, ti·∫øn h√†nh commit..."
            git add models/* all_cities_aqi_data.csv
            git commit -m "üîÑ Auto update models and data"
            git push
          else
            echo "‚úÖ Kh√¥ng c√≥ thay ƒë·ªïi n√†o trong m√¥ h√¨nh ho·∫∑c d·ªØ li·ªáu."
